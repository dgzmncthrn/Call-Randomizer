<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DXC QA Call Randomizer</title>

<style>
body{font-family:Segoe UI,Arial;background:#eef2f7;padding:20px}
h2,h3{color:#002A5C}
.card{background:#fff;padding:15px;border-radius:10px;margin-bottom:15px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
button{background:#0067B8;color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer}
button.alt{background:#444}
input,select,textarea{padding:6px;margin-right:6px}

input,select,textarea{
  border-radius:8px;
  border:1px solid #c9d4e5;
  padding:8px 10px;
  font-family:Segoe UI,sans-serif;
  font-size:13px;
  outline:none;
  transition:all .15s ease-in-out;
}

input:focus,select:focus,textarea:focus{
  border-color:#0067B8;
  box-shadow:0 0 0 2px rgba(0,103,184,.15)
}

textarea{width:100%;height:140px;resize:vertical}
.stat{font-size:15px;margin-right:20px}

table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  border-radius:10px;
  overflow:hidden;
  background:#fff;
  box-shadow:0 1px 4px rgba(0,0,0,.06);
  font-size:12px
}

th{
  background:#002A5C;
  color:#fff;
  padding:10px 8px;
  font-weight:600;
  text-align:left
}

td{
  border-top:1px solid #e4e9f1;
  padding:8px;
  color:#333
}

tr:hover td{background:#f4f8fd}

.badge{background:#002A5C;color:#fff;padding:4px 10px;border-radius:12px;font-size:12px}
.progress{height:12px;background:#ddd;border-radius:6px;overflow:hidden}
.progress div{height:100%;background:#0067B8}

button.started {
  background: #f5a623;   /* amber */
  cursor: not-allowed;
}

button.submitted {
  background: #2e8b57;   /* green */
  cursor: not-allowed;
}

button.paused {
  background: #999;
}

button.running {
  background: #f5a623;
}

</style>
</head>

<body>

<h2>DXC QA Call Randomizer</h2>

<div class="card">
 Reviewer <input id="reviewer">

 Account
 <input id="account" placeholder="Enter account name" style="width:180px">

 Weekly Quota <input id="quota" type="number" value="20" style="width:70px">
 <button onclick="loadData()">Load Data</button>
 <br><br>
 <textarea id="raw" placeholder="Paste CX export (tab-delimited)"></textarea>
</div>

<div class="card">
 <span class="stat">Available <b id="statAvail">0</b></span>
 <span class="stat">Audited <b id="statDone">0</b></span>
 <span class="stat">Avg Cycle <b id="statCycle">00:00</b></span>
 <span class="stat">Productivity <b id="statProd">0</b>/hr</span>
</div>

<div class="card">
 Agent <select id="agent"></select>

 Queue
 <select id="queue">
  <option value="ALL">All Queues</option>
 </select>

 Date From <input type="date" id="dFrom">
 To <input type="date" id="dTo">

 Duration
 <select id="dtype">
  <option>Super Short</option>
  <option>Short</option>
  <option>Long</option>
  <option>Super Long</option>
 </select>

 Count <input id="count" value="1" style="width:50px">
 <button onclick="generateAudit()">Generate Audit</button>
</div>

<div class="card">
 <h3>ðŸ“ž Current Audit</h3>
 <div id="currentAudit"><i>No active audit</i></div>
 <br>
<button id="btnStart" onclick="startAudit()">Start</button>
<button id="btnPause" onclick="pauseAudit()">Pause</button>
<button id="btnSubmit" onclick="submitAudit()">Submit</button>


</div>

<div class="card">
 <h3>Work Week: <span id="weekLabel" class="badge"></span></h3>
 Weekly Progress
 <div class="progress"><div id="progBar"></div></div>
</div>

<div class="card">
 <h3>Audit History</h3>

 View Week
 <select id="viewWeek" onchange="renderHistory()">
  <option value="ALL">All Weeks</option>
 </select>

 Account
 <select id="viewAccount" onchange="renderHistory()">
  <option value="ALL">All Accounts</option>
 </select>

 Name
 <input id="filterReviewer" placeholder="Filter by agent name" oninput="renderHistory()">

 <button onclick="exportCSV()">Export</button>
 <button class="alt" onclick="clearWeek()">Clear Week</button>
 <button class="alt" onclick="clearAll()">Clear All</button>

 <br><br>
 <div id="hist"></div>
</div>

<script>
let calls=[];
let history=JSON.parse(localStorage.getItem("qaHistory")||"[]");
let currentAudit=null;
let auditStart=null;

function loadData(){
 calls=[];
 let txt=raw.value.trim();
 if(!txt){alert("Paste data first");return;}

 let rows=txt.split("\n");rows.shift();
 let agents=new Set(),queues=new Set();

 rows.forEach(r=>{
  let c=r.split("\t");
  if(c.length<11)return;

  let sec=t2s(c[10]);
  let type=classify(sec);
  let ww=getWorkWeek(c[3]);

  if(history.find(h=>h.id===c[0]))return;

  calls.push({
    id:c[0],
    agent:c[6],
    queue:c[5],          // <-- QUEUE CAPTURE
    date:c[3],
    interact:c[10],
    dur:c[9],
    sec,
    type,
    week:ww
  });

  agents.add(c[6]);
  if(c[5]) queues.add(c[5]);
 });

 agent.innerHTML=[...agents].map(a=>`<option>${a}</option>`).join("");
 queue.innerHTML=`<option value="ALL">All Queues</option>`+
   [...queues].map(q=>`<option>${q}</option>`).join("");

 updateStats();

 raw.value = "";

}

function generateAudit(){
 let pool=calls.filter(c=>{
  if(c.agent!==agent.value)return false;
  if(queue.value!=="ALL" && c.queue!==queue.value)return false;
  if(c.type!==dtype.value)return false;
  if(dFrom.value && c.date<dFrom.value)return false;
  if(dTo.value && c.date>dTo.value)return false;
  return true;
 });

 if(!pool.length){alert("No matching calls");return;}

 currentAudit=pool[Math.floor(Math.random()*pool.length)];
 calls=calls.filter(c=>c!==currentAudit);

 currentAudit.reviewer=reviewer.value;
 currentAudit.account=account.value;

 showCurrentAudit();

elapsedPause = 0;
isPaused = false;

btnStart.innerText = "Start";
btnStart.classList.remove("running");

btnPause.innerText = "Pause";
btnPause.classList.remove("paused");

btnSubmit.innerText = "Submit";
btnSubmit.classList.remove("submitted");

}

function showCurrentAudit(){
 currentAuditDiv.innerHTML=`
  <b>Contact:</b> <span id="contactID">${currentAudit.id}</span>
  <button onclick="copyContact()" style="margin-left:10px">Copy</button>
  <span id="copyMsg" style="margin-left:8px;color:#0067B8;font-size:12px"></span><br>
  <b>Agent:</b> ${currentAudit.agent}<br>
  <b>Date:</b> ${currentAudit.date}<br>
  <b>Duration:</b> ${currentAudit.interact}<br>
  <b>Type:</b> ${currentAudit.type}<br>
  <b>Week:</b> ${formatWeek(currentAudit.week)}
 `;
}


function copyContact(){
 let id=document.getElementById("contactID").innerText;
 navigator.clipboard.writeText(id);

 let msg=document.getElementById("copyMsg");
 msg.innerText="Copied âœ”";

 setTimeout(()=>{msg.innerText="";},2000);
}


function startAudit(){
 if(!currentAudit){
   alert("Generate an audit first");
   return;
 }

 // Resume OR first start
 if(auditStart) return; // already running

 auditStart = Date.now();
 isPaused = false;

 btnStart.classList.add("running");
 btnStart.innerText = "Running";

 btnPause.classList.remove("paused");
 btnPause.innerText = "Pause";
}


function pauseAudit(){
 if(!auditStart || isPaused) return;

 elapsedPause += Math.floor((Date.now() - auditStart) / 1000);
 auditStart = null;
 isPaused = true;

 btnPause.classList.add("paused");
 btnPause.innerText = "Paused";

 btnStart.classList.remove("running");
 btnStart.innerText = "Resume";
}

function submitAudit(){
 if(!auditStart && !isPaused){alert("Start the audit first");return;}

 if(auditStart){
   elapsedPause += Math.floor((Date.now() - auditStart) / 1000);
 }

 history.push({...currentAudit,cycle:s2t(elapsedPause)});

 currentAudit = null;
 auditStart = null;
 elapsedPause = 0;
 isPaused = false;

 currentAuditDiv.innerHTML="<i>No active audit</i>";

 btnStart.innerText="Start";
 btnStart.classList.remove("running");

 btnPause.innerText="Pause";
 btnPause.classList.remove("paused");

 btnSubmit.classList.add("submitted");
 btnSubmit.innerText="Submitted";

 save();
 renderHistory();
 updateStats();
}



function renderHistory(){
 let vw=viewWeek.value;
 let va=viewAccount.value;
 let fr=filterReviewer.value.toLowerCase();

 let h="<table><tr><th>Reviewer</th><th>Account</th><th>Agent</th><th>Contact</th><th>Date</th><th>Week</th><th>Type</th><th>Cycle</th></tr>";

 history.filter(x=>{
  if(fr && !x.agent.toLowerCase().includes(fr))return false;
  if(vw!=="ALL" && x.week!==vw)return false;
  if(va!=="ALL" && x.account!==va)return false;
  return true;
 }).forEach(c=>{
  h+=`<tr>
    <td>${c.reviewer}</td>
    <td>${c.account}</td>
    <td>${c.agent}</td>
    <td>${c.id}</td>
    <td>${c.date}</td>
    <td>${formatWeek(c.week)}</td>
    <td>${c.type}</td>
    <td>${c.cycle}</td>
  </tr>`;
 });

 hist.innerHTML=h+"</table>";
}

function updateStats(){
 statAvail.innerText=calls.length;
 statDone.innerText=history.length;

 let total=0,c=0;
 history.forEach(h=>{if(h.cycle){total+=t2s("0:"+h.cycle);c++;}});
 let avg=c?Math.floor(total/c):0;
 statCycle.innerText=s2t(avg);
 statProd.innerText=avg?Math.round(3600/avg):0;

 let ww=getWorkWeek(new Date().toISOString().split("T")[0]);
 weekLabel.innerText=formatWeek(ww);
 let wdone=history.filter(h=>h.week===ww).length;
 progBar.style.width=Math.min(100,(wdone/(+quota.value||1))*100)+"%";

 if(![...viewWeek.options].some(o=>o.value===ww)){
  viewWeek.innerHTML+=`<option value="${ww}">${formatWeek(ww)}</option>`;
 }

 let accs=[...new Set(history.map(h=>h.account).filter(Boolean))];
 viewAccount.innerHTML=`<option value="ALL">All Accounts</option>`+
   accs.map(a=>`<option>${a}</option>`).join("");
}

function exportCSV(){
 let vw=viewWeek.value;
 let va=viewAccount.value;
 let name=reviewer.value||"Reviewer";
 let wk=vw==="ALL"?"ALL":formatWeek(vw);

 let out="Reviewer,Account,Agent,ContactID,Date,WorkWeek,Type,Cycle\n";
 history.filter(h=>{
  if(vw!=="ALL" && h.week!==vw)return false;
  if(va!=="ALL" && h.account!==va)return false;
  return true;
 }).forEach(h=>{
  out+=`${h.reviewer},${h.account},${h.agent},${h.id},${h.date},${h.week},${h.type},${h.cycle}\n`;
 });

 let a=document.createElement("a");
 a.href=URL.createObjectURL(new Blob([out]));
 a.download=`${name}-${va}-${wk}.csv`;
 a.click();
}

function clearWeek(){
 let ww=getWorkWeek(new Date().toISOString().split("T")[0]);
 history=history.filter(h=>h.week!==ww);
 save();renderHistory();updateStats();
}

function clearAll(){
 if(confirm("Clear ALL history?")){
  history=[];save();renderHistory();updateStats();
 }
}

function save(){localStorage.setItem("qaHistory",JSON.stringify(history));}
function classify(s){return s<180?"Super Short":s<420?"Short":s<840?"Long":"Super Long";}
function t2s(t){let p=t.split(":");return(+p[0])*3600+(+p[1])*60+(+p[2]);}
function s2t(s){let m=Math.floor(s/60),r=s%60;return String(m).padStart(2,"0")+":"+String(r).padStart(2,"0");}

function getWorkWeek(d){
 let x=new Date(d),day=x.getDay();
 let diff=5-day;if(diff<0)diff+=7;
 x.setDate(x.getDate()+diff);
 return String(x.getMonth()+1).padStart(2,"0")+String(x.getDate()).padStart(2,"0");
}

function formatWeek(w){return`WE${w}`;}

const currentAuditDiv=document.getElementById("currentAudit");
renderHistory();updateStats();


</script>

</body>
</html>

<footer>callrandomizer.v013026_cdg</footer>
